<?xml version="1.0"?>
<workflow id="13">
  <name>aes - Inscription &#224; une plaine (validation semaine automatique)</name>
  <roles>
    <role id="_debug">Debug</role>
    <role id="_receiver">Agent traitant</role>
  </roles><possible_status>
    <status>
      <id>1</id>
      <name>Demande de r&#233;servation de semaines de plaine.</name>
      <colour>FFFFFF</colour>
      <visibility />
      <items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo12327eb7-292e-4599-8770-f59b17b60c69</field_id>
              <value>{{ form_user_email }}</value>
            </field><field>
              <field_id>boe38e8ffb-9eea-4ca5-8433-562d88c254bf</field_id>
              <value>=",".join(sorted(set("{}/{}/{}".format(jour.split('_')[2].split('-')[2],jour.split('_')[2].split('-')[1],jour.split('_')[2].split('-')[0]) for jour in form_var_selected_plaines_raw)))</value>
            </field><field>
              <field_id>bo0f67dbe9-82df-467a-adec-eb6e944f97af</field_id>
              <value>=",".join(sorted(set(jour.split('_')[1] for jour in form_var_selected_plaines_raw))).lower()</value>
            </field><field>
              <field_id>bob9991026-8b9a-4aa8-8161-bd6d26ac0b42</field_id>
              <value>=0</value>
            </field><field>
              <field_id>bo536eed66-8e9a-4c58-b4d5-c54c84f0ccc8</field_id>
              <value>=len(form_var_semaines_de_plaine.split(","))</value>
            </field><field>
              <field_id>bo17043065-244b-43fb-9911-148cfd2e2a96</field_id>
              <value>=["{}_{}".format(tuple(s)[0][0], tuple(s)[0][1]) for s in set(frozenset(d.items()) for d in [{jour.split("_")[1]:"{}/{}/{}".format(jour.split("_")[2].split("-")[2],jour.split("_")[2].split("-")[1],jour.split("_")[2].split("-")[0])} for jour in form_var_selected_plaines_raw])]</value>
            </field><field>
              <field_id>bo87ac6923-e30f-4862-9d91-d6a3f06f96bb</field_id>
              <value>=""</value>
            </field><field>
              <field_id>bo5756c702-afb1-486a-8300-c45736a4148a</field_id>
              <value>{{form_option_first_date_plain}}</value>
            </field><field>
              <field_id>boccf860cf-383c-4cf6-9137-c7db1283e229</field_id>
              <value>{{form_option_last_date_plain}}</value>
            </field><field>
              <field_id>bo5f6a808e-3e82-47bc-8f93-fdd8887c5309</field_id>
              <value>=False</value>
            </field><field>
              <field_id>boecf95bcc-b6f3-4c69-97a8-eb17e5d4ca76</field_id>
              <value>=webservice.aes_get_parent_id.get("id")</value>
            </field><field>
              <field_id>bo3b7197e9-7b19-4e8e-9fb4-f9b3b9a7c89c</field_id>
              <value>=False</value>
            </field><field>
              <field_id>bo7614c7ef-0731-4205-9cd1-9bdfa9e26544</field_id>
              <value>=False</value>
            </field>
          </fields>
        </item><item id="2" type="webservice_call">
          <label>Enregistrements des occurences s&#233;lectionn&#233;es</label>
          <url>{{ passerelle_url }}passerelle-imio-ia-aes/aes/add_registration_child_plaine</url>
          <method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>form_id</name>
              <value>=form_number_raw</value>
            </item><item>
              <name>data</name>
              <value>=form_var_selected_plaines_raw</value>
            </item><item>
              <name>child_id</name>
              <value>=form_var_selected_child_raw</value>
            </item>
          </post_data><response_type>json</response_type>
          <varname>aes_registration_child_plaine</varname>
          <action_on_app_error>2</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>True</record_errors>
        </item><item id="3" type="jump">
          <status>7</status>
          <condition>
            <type>python</type>
            <value>aes_registration_child_plaine_response is True</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="4" type="sendmail">
          <to>
            <item role_id="_submitter">_submitter</item>
          </to><subject>Portail parent : R&#233;servation &#224; des semaines de plaine.</subject>
          <body>{{ form_user_var_title }} {{ form_user_var_last_name }} {{ form_user_var_first_name }}, 

Nous prenons bien connaissance de votre r&#233;servation de semaine(s) de plaine.

Si vous n'avez plus d'autre r&#233;servation &#224; effectuer, n'oubliez pas de cl&#244;turer votre derni&#232;re demande (elle cl&#244;turera automatiquement les pr&#233;c&#233;dentes).

A d&#233;faut, les places que vous aurez r&#233;serv&#233; seront lib&#233;r&#233;es.

`Consulter ma demande &lt;{{ form_url }}&gt;`_

 
Bien cordialement, </body>
        </item><item id="5" type="sendmail">
          <to>
            <item role_id="_receiver">_receiver</item>
          </to><subject>{{ pp_wplaine_sujet_mail_agent_demande_inscr }}</subject>
          <body>{{ pp_wplaine_corps_mail_agent_demande_inscr }}</body>
        </item><item id="6" type="choice">
          <label>debug</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>1</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>2</id>
      <name>R&#233;servation &#233;chou&#233;e</name>
      <colour>FF0000</colour>
      <visibility />
      <items>
        <item id="1" type="register-comment">
          <comment>&lt;div&gt;
{{ pp_wfplaine_histo_error }}
&lt;/div&gt;</comment>
        </item><item id="2" type="sendmail">
          <to>
            <item role_id="_receiver">_receiver</item>
            <item role_id="_debug">_debug</item>
          </to><subject>{{ commune_name }} : Erreur {{ form_name }} :  {{ form_number }}</subject>
          <body>D&#233;marches en &#233;chec : 

{{ form_url_backoffice }}

Bien cordialement,</body>
        </item><item id="3" type="choice">
          <label>DEBUG</label>
          <by>
            <item role_id="52c6b8da2da745efb074ea2c30fa6741">Debug</item>
          </by><status>1</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>4</id>
      <name>R&#233;servation accept&#233;e</name>
      <colour>0066FF</colour>
      <visibility />
      <items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo87ac6923-e30f-4862-9d91-d6a3f06f96bb</field_id>
              <value>=form_var_finalmail + "&lt;li&gt;Accept&#233; pour la semaine du {} au {}&lt;/li&gt;".format(script.pp_get_dates_from_week_number()[0], script.pp_get_dates_from_week_number()[1])</value>
            </field><field>
              <field_id>bo489d9a74-3e88-46f2-b98f-c815b2033927</field_id>
              <value>="Accept&#233; pour la semaine du {} au {} ".format(script.pp_get_dates_from_week_number()[0], script.pp_get_dates_from_week_number()[1])</value>
            </field><field>
              <field_id>bob9991026-8b9a-4aa8-8161-bd6d26ac0b42</field_id>
              <value>=int(form_var_cpt_aes_response) + 1</value>
            </field>
          </fields>
        </item><item id="2" type="register-comment">
          <comment>&lt;div&gt;
Nous avons le plaisir de vous confirmer l'inscription de {{ form_var_selected_child_firstname }} &#224; notre/nos plaine(s) pour le(s) jour(s) suivant :&lt;br/&gt;
{{ form_var_msg_status_histo }}
&lt;/div&gt;</comment>
        </item><item id="3" type="sendmail">
          <to>
            <item role_id="_submitter">_submitter</item>
          </to><subject>Portail parent : Inscription &#224; la plaine accept&#233;e</subject>
          <body>{{ form_user_var_title }} {{ form_user_var_last_name }} {{ form_user_var_first_name }}, 

Nous avons le plaisir de vous confirmer l'inscription de votre enfant &#224; notre/nos plaine(s).

Ci-dessous, veuillez retrouver les diff&#233;rents jours pour lesquels {{ form_var_selected_child_firstname }} sera pr&#233;sent :

{{form_var_jours_de_plaine}}


Bien cordialement, </body>
          <condition>
            <type>python</type>
            <value>False</value>
          </condition>
        </item><item id="4" type="jump">
          <status>8</status>
          <condition>
            <type>python</type>
            <value>int(form_var_cpt_aes_response) &gt;= int(form_var_nb_weeks)</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="5" type="jump">
          <status>16</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>5</id>
      <name>Cl&#244;tur&#233;</name>
      <colour>00FF00</colour>
      <forced_endpoint>true</forced_endpoint>
      <visibility />
      <items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo3d9cb807-a5af-44db-b4f8-abc5bb9c0adf</field_id>
              <value>=script.pp_close_plaines_reservations() if form_var_is_closing_request_raw is True else ""</value>
            </field><field>
              <field_id>bo43d4f153-0ad6-4d0b-a31f-b24d11709299</field_id>
              <value>{{ now }}</value>
            </field><field>
              <field_id>bo3b7197e9-7b19-4e8e-9fb4-f9b3b9a7c89c</field_id>
              <value>=True</value>
            </field>
          </fields>
        </item><item id="2" type="jump">
          <status>10</status>
          <condition>
            <type>python</type>
            <value>form_var_is_closing_request_raw is True</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="3" type="jump">
          <status>15</status>
          <condition>
            <type>python</type>
            <value>utils.age_in_days(form_var_in_basket_date) &gt;= int(form_option_nb_days_before_free_places)</value>
          </condition><timeout>82800</timeout>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="4" type="choice">
          <label>debug inscrire un autre enfant</label>
          <by>
            <item role_id="_debug">_debug</item>
            <item role_id="_submitter">_submitter</item>
          </by><status>8</status>
          <require_confirmation>False</require_confirmation>
          <backoffice_info_text>&lt;p&gt;dans le cadre d'une mauvaise cloture pour les demandes qui ne finalisent pas&lt;/p&gt;</backoffice_info_text>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="5" type="jump">
          <status>11</status>
          <condition>
            <type>python</type>
            <value>form_var_is_closing_request_raw is False</value>
          </condition><trigger>closed_and_paid</trigger>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="6" type="choice">
          <label>Debug : lib&#233;ration des places</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>15</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>6</id>
      <name>Plus de place!</name>
      <colour>FF0000</colour>
      <visibility />
      <items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo87ac6923-e30f-4862-9d91-d6a3f06f96bb</field_id>
              <value>=form_var_finalmail + "&lt;li&gt;Refus pour la semaine du {} au {}&lt;/li&gt;".format(script.pp_get_dates_from_week_number()[0], script.pp_get_dates_from_week_number()[1])</value>
            </field><field>
              <field_id>bo489d9a74-3e88-46f2-b98f-c815b2033927</field_id>
              <value>="Refus pour la semaine du {} au {} ".format(script.pp_get_dates_from_week_number()[0], script.pp_get_dates_from_week_number()[1])</value>
            </field><field>
              <field_id>bob9991026-8b9a-4aa8-8161-bd6d26ac0b42</field_id>
              <value>=int(form_var_cpt_aes_response) + 1</value>
            </field><field>
              <field_id>bo9a83f6a7-2b4e-4c01-8950-193376e2c412</field_id>
              <value>=int(form_var_cpt_no_more_place) + 1</value>
            </field>
          </fields>
        </item><item id="2" type="register-comment">
          <comment>&lt;div&gt;
Nous sommes au regret de vous annoncer que l'inscription de {{ form_var_selected_child_firstname }} &#224; notre/nos plaine(s) pour le(s) jour(s) suivant :&lt;br/&gt;
{{ form_var_msg_status_histo }}&lt;/br&gt;
n'est pas possible.
&lt;/div&gt;</comment>
        </item><item id="3" type="sendmail">
          <to>
            <item role_id="_submitter">_submitter</item>
          </to><subject>Portail parent : Inscription &#224; la plaine refus&#233;e</subject>
          <body>{{ form_user_var_title }} {{ form_user_var_last_name }} {{ form_user_var_first_name }}, 

Nous sommes au regret de vous annoncer le refus de l'inscription de votre enfant &#224; notre plaine.

Bien cordialement, </body>
          <condition>
            <type>python</type>
            <value>False</value>
          </condition>
        </item><item id="4" type="jump">
          <status>17</status>
          <condition>
            <type>python</type>
            <value>int(form_var_cpt_no_more_place) &gt;= int(form_var_nb_weeks)</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="5" type="jump">
          <status>8</status>
          <condition>
            <type>python</type>
            <value>int(form_var_cpt_aes_response) &gt;= int(form_var_nb_weeks)</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="6" type="jump">
          <status>16</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>7</id>
      <name>ack AES</name>
      <colour>000000</colour>
      <visibility>
        <role>_receiver</role>
        <role>_debug</role>
      </visibility><items>
        <item id="1" type="webservice_call">
          <url>{{ passerelle_url }}passerelle-imio-ia-aes/aes/validate_form</url>
          <method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>form_id</name>
              <value>=form_number_raw</value>
            </item>
          </post_data><response_type>json</response_type>
          <action_on_app_error>:pass</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>False</record_errors>
          <condition>
            <type>python</type>
            <value>int(form_var_cpt_aes_response) == 0</value>
          </condition>
        </item><item id="2" type="jump">
          <status>16</status>
          <trigger>validate</trigger>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="3" type="jump">
          <status>12</status>
          <timeout>1200</timeout>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>8</id>
      <name>Inscrire un nouvel enfant ou cl&#244;turer ma demande ?</name>
      <colour>0066FF</colour>
      <visibility />
      <items>
        <item id="1" type="register-comment">
          <comment>&lt;div&gt;
&lt;p&gt;Si vous cl&#244;turer, vous nous indiquez que vous avez inscrit vos diff&#233;rents enfants (1 demande par enfant).&lt;/p&gt; 
&lt;p&gt;Vous acceptez que le calcul du tarif se fasse sur base des enfants inscris jusqu'&#224; cette cl&#244;ture.&lt;/p&gt;
&lt;/div&gt;</comment>
        </item><item id="2" type="resubmit">
          <by>
            <item role_id="_submitter">_submitter</item>
          </by><label>Inscrire un nouvel enfant</label>
          <formdef_slug>_same</formdef_slug>
        </item><item id="3" type="jumponsubmit">
          <status>9</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="4" type="choice">
          <label>Cloturer mes demandes</label>
          <by>
            <item role_id="_submitter">_submitter</item>
            <item role_id="logged-users">logged-users</item>
          </by><status>14</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
          <identifier>is_closing_request_action</identifier>
        </item><item id="5" type="sendmail">
          <to>
            <item role_id="_submitter">_submitter</item>
          </to><subject>Plaines : Votre demande {{ form_number }} du portail parent.</subject>
          <body>&lt;div&gt;
{{ form_user_var_title }} {{ form_user_var_first_name }} {{ form_user_var_last_name }},
&lt;br /&gt;
Nous avons finalis&#233; le traitement de votre demande soumise le {{ form_receipt_date }}.
&lt;br /&gt;
Ci-dessous, veuillez retrouver les semaines accept&#233;es ou refus&#233;es pour votre demande : 

&lt;ul&gt;
{{ form_var_finalmail|safe }}
&lt;/ul&gt;

&lt;a href="{{ form_url }}"&gt;Consulter l'historique de votre demande&lt;/a&gt;
&lt;p&gt;
Bien cordialement, 
&lt;/p&gt;
&lt;/div&gt;</body>
        </item><item id="6" type="jump">
          <status>5</status>
          <trigger>cloture</trigger>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>9</id>
      <name>Inscrire un nouvel enfant</name>
      <colour>FFFFFF</colour>
      <visibility />
      <items>
        <item id="1" type="redirect_to_url">
          <url>{{ resubmit_formdata_draft_url }}</url>
        </item><item id="2" type="jump">
          <status>5</status>
          <trigger>cloture</trigger>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="3" type="choice">
          <label>Cloturer mes demandes</label>
          <by>
            <item role_id="_submitter">_submitter</item>
          </by><status>14</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>10</id>
      <name>Panier</name>
      <colour>FFFF66</colour>
      <visibility />
      <items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo9620a85b-a884-4b8f-84ff-024dc4f516af</field_id>
              <value>="Article : \"R&#233;servation de plaine(s)\" pour les demandes n&#176; {}".format(form_var_closed_plaines) if "," in form_var_closed_plaines else "Article : \"R&#233;servation de plaine(s)\" pour la demande n&#176; {}".format(form_var_closed_plaines) </value>
            </field>
          </fields>
        </item><item id="2" type="webservice_call">
          <label>AES</label>
          <url>{{ passerelle_url }}passerelle-imio-ia-aes/aes/close_plaines_reservation</url>
          <method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>form_ids</name>
              <value>=form_var_closed_plaines.split(",")</value>
            </item>
          </post_data><response_type>json</response_type>
          <varname>aes_closed_and_pay</varname>
          <action_on_app_error>18</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>False</record_errors>
        </item><item id="3" type="jump">
          <status>18</status>
          <condition>
            <type>python</type>
            <value>vars().get("aes_closed_and_pay_response") is False</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="4" type="webservice_call">
          <label>Panier</label>
          <url>{{portal_url}}api/lingo/add-basket-item?NameId={{form_user_name_identifier_0}}&amp;cancellable=no</url>
          <qs_data>
            <item>
              <name>regie_id</name>
              <value>atos_prod</value>
            </item>
          </qs_data><method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>display_name</name>
              <value>{{ form_var_label_basket_item }}</value>
            </item><item>
              <name>url</name>
              <value>{{ form_url }}</value>
            </item><item>
              <name>amount</name>
              <value>=str(aes_closed_and_pay_response_data_amount)</value>
            </item><item>
              <name>nb_documents</name>
              <value>1</value>
            </item>
          </post_data><response_type>json</response_type>
          <varname>panier</varname>
          <action_on_app_error>:pass</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>True</record_errors>
        </item><item id="5" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo7614c7ef-0731-4205-9cd1-9bdfa9e26544</field_id>
              <value>=True</value>
            </field>
          </fields>
        </item><item id="6" type="register-comment">
          <comment>&lt;div&gt;
&lt;p&gt;{{ form_var_label_basket_item }}&lt;/p&gt;
&lt;p&gt;&lt;h1 class="pp_panier"&gt;&lt;a href="{{ portal_url}}/panier"&gt;R&#233;gler mon panier&lt;/a&gt;&lt;/h1&gt;&lt;/p&gt;
&lt;/div&gt;</comment>
        </item><item id="7" type="jump">
          <status>11</status>
          <trigger>paid</trigger>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="8" type="jump">
          <status>15</status>
          <condition>
            <type>python</type>
            <value>utils.age_in_days(form_var_in_basket_date) &gt;= int(form_option_nb_days_before_free_places)</value>
          </condition><timeout>82800</timeout>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="9" type="choice">
          <label>FREE UP PLACES</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>15</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="10" type="choice">
          <label>debug</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>10</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="11" type="choice">
          <label>Retirer mon article du panier et lib&#233;rer les places.</label>
          <by>
            <item role_id="_submitter">_submitter</item>
          </by><status>15</status>
          <require_confirmation>True</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="12" type="choice">
          <label>debug panier</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>10</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>11</id>
      <name>Cl&#244;tur&#233; et pay&#233;</name>
      <colour>00FF00</colour>
      <forced_endpoint>true</forced_endpoint>
      <visibility />
      <items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo96d77efd-9a54-492d-940b-9c11e1282761</field_id>
              <value>=script.pp_close_plaines_reservations() if form_var_is_closing_request_raw is True else ""</value>
            </field>
          </fields>
        </item><item id="2" type="webservice_call">
          <label>Avertir AES que le pr&#233;paiement a &#233;t&#233; r&#233;alis&#233;</label>
          <url>{{ passerelle_url }}passerelle-imio-ia-aes/aes/pay_prepaid</url>
          <method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>parent_id</name>
              <value>{{ form_var_aes_parent_id }}</value>
            </item><item>
              <name>form_id</name>
              <value>{{ form_number_raw }}</value>
            </item><item>
              <name>amount</name>
              <value>{{ aes_closed_and_pay_response_data_amount }}</value>
            </item>
          </post_data><response_type>json</response_type>
          <varname>aes_prepaid_done</varname>
          <action_on_app_error>18</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>False</record_errors>
          <condition>
            <type>python</type>
            <value>form_var_is_closing_request_raw is True</value>
          </condition>
        </item><item id="3" type="choice">
          <label>Debug : lib&#233;ration des places</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>15</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>12</id>
      <name>Attention, une semaine n'est pas valid&#233;e</name>
      <colour>000000</colour>
      <visibility>
        <role>_receiver</role>
        <role>_debug</role>
      </visibility><items />
    </status><status>
      <id>14</id>
      <name>is_closing_request</name>
      <colour>000000</colour>
      <visibility>
        <role>_receiver</role>
        <role>_debug</role>
      </visibility><items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo5f6a808e-3e82-47bc-8f93-fdd8887c5309</field_id>
              <value>=True</value>
            </field>
          </fields>
        </item><item id="2" type="jump">
          <status>5</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>15</id>
      <name>Non paiement. Lib&#233;ration des places</name>
      <colour>FF0000</colour>
      <visibility />
      <items>
        <item id="1" type="webservice_call">
          <label>Non paiement : Lib&#233;ration des places.</label>
          <url>{{ passerelle_url }}passerelle-imio-ia-aes/aes/free_up_places</url>
          <method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>form_ids</name>
              <value>=form_var_closed_plaines.split(",")</value>
            </item>
          </post_data><response_type>json</response_type>
          <varname>aes_free_up_places</varname>
          <action_on_app_error>18</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>True</record_errors>
          <condition>
            <type>python</type>
            <value>form_var_is_closing_request_raw is True</value>
          </condition>
        </item><item id="2" type="webservice_call">
          <label>Suppression de l'article hors du panier</label>
          <url>{{portal_url}}/api/lingo/remove-basket-item?NameId={{form_user_name_identifier_0}}</url>
          <method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>skip_notification</name>
              <value>skip</value>
            </item><item>
              <name>basket_item_id</name>
              <value>{{ panier_response_id }}</value>
            </item>
          </post_data><response_type>json</response_type>
          <action_on_app_error>:pass</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>False</record_errors>
        </item><item id="3" type="choice">
          <label>debug free up places</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>15</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="4" type="choice">
          <label>debug</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>5</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>16</id>
      <name>validate</name>
      <colour>000000</colour>
      <visibility>
        <role>_receiver</role>
        <role>_debug</role>
      </visibility><items>
        <item id="1" type="set-backoffice-fields">
          <label>Semaine en cours de validation</label>
          <fields>
            <field>
              <field_id>bof0e2cd2d-c92a-460a-99c6-8abdcbedd541</field_id>
              <value>=form_var_semaines_de_plaine.lower().split(",")[int(form_var_cpt_aes_response)]</value>
            </field>
          </fields>
        </item><item id="2" type="jump">
          <status>4</status>
          <condition>
            <type>python</type>
            <value>form_var_current_validating_week in aes_week_validate</value>
          </condition><set_marker_on_status>False</set_marker_on_status>
        </item><item id="3" type="jump">
          <status>6</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>17</id>
      <name>Plus aucune place!</name>
      <colour>FF0000</colour>
      <visibility />
      <items>
        <item id="1" type="register-comment">
          <comment>&lt;div&gt;
Nous sommes d&#233;sol&#233; mais il semble que &lt;b&gt;toutes les places&lt;/b&gt; que vous aviez choisis dans votre formulaire &lt;b&gt;ont &#233;t&#233; r&#233;serv&#233;e entre temps !&lt;/b&gt; 
&lt;/div&gt;</comment>
        </item>
      </items>
    </status><status>
      <id>18</id>
      <name>Echec</name>
      <colour>FF0000</colour>
      <visibility />
      <items>
        <item id="1" type="choice">
          <label>debug cloture</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>19</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="2" type="choice">
          <label>debug free up places</label>
          <by>
            <item role_id="_debug">_debug</item>
          </by><status>15</status>
          <require_confirmation>False</require_confirmation>
          <ignore_form_errors>False</ignore_form_errors>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="3" type="register-comment">
          <comment>&lt;div&gt;
&lt;p&gt;Un probl&#232;me est survenu.&lt;/p&gt;
&lt;p&gt;Un mail a &#233;t&#233; envoy&#233; &#224; notre administration pour traiter ce probl&#232;me.&lt;/p&gt;
&lt;p&gt;Nous vous tenons inform&#233; de la suite dans les plus brefs d&#233;lais.&lt;/p&gt;
&lt;/div&gt;</comment>
        </item><item id="4" type="sendmail">
          <to>
            <item role_id="_receiver">_receiver</item>
            <item role_id="_debug">_debug</item>
          </to><subject>{{ commune_name }} : Erreur {{ form_name }} :  {{ form_number }}</subject>
          <body>&lt;div&gt;

Une d&#233;marche est en &#233;chec lors de la cl&#244;ture ou de la finalisation de la demande (cl&#244;tur&#233; et pay&#233;) : 

&lt;a href="{{ form_url_backoffice }}"&gt;Veuillez suivre ce lien pour voir la d&#233;marche dont la cl&#244;ture a &#233;chou&#233;e&lt;/a&gt;

Bien cordialement,

&lt;/div&gt;</body>
        </item>
      </items>
    </status><status>
      <id>19</id>
      <name>is_close_false</name>
      <colour>000000</colour>
      <visibility>
        <role>_debug</role>
        <role>_receiver</role>
      </visibility><items>
        <item id="1" type="set-backoffice-fields">
          <fields>
            <field>
              <field_id>bo3b7197e9-7b19-4e8e-9fb4-f9b3b9a7c89c</field_id>
              <value>=False</value>
            </field>
          </fields>
        </item><item id="2" type="jump">
          <status>5</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>20</id>
      <name>_Panier</name>
      <colour>FFFF00</colour>
      <visibility />
      <items>
        <item id="1" type="webservice_call">
          <label>Panier</label>
          <url>{{portal_url}}api/lingo/add-basket-item?NameId={{form_user_name_identifier_0}}&amp;cancellable=no</url>
          <qs_data>
            <item>
              <name>regie_id</name>
              <value>atos_prod</value>
            </item>
          </qs_data><method>POST</method>
          <post>False</post>
          <post_data>
            <item>
              <name>display_name</name>
              <value>{{ form_var_label_basket_item }}</value>
            </item><item>
              <name>url</name>
              <value>{{ form_url }}</value>
            </item><item>
              <name>amount</name>
              <value>{{manual_var_amount}}</value>
            </item><item>
              <name>nb_documents</name>
              <value>1</value>
            </item>
          </post_data><response_type>json</response_type>
          <varname>manual_basket</varname>
          <action_on_app_error>18</action_on_app_error>
          <action_on_4xx>:stop</action_on_4xx>
          <action_on_5xx>:stop</action_on_5xx>
          <action_on_bad_data>:pass</action_on_bad_data>
          <action_on_network_errors>:stop</action_on_network_errors>
          <notify_on_errors>True</notify_on_errors>
          <record_on_errors>True</record_on_errors>
          <record_errors>True</record_errors>
        </item><item id="2" type="jump">
          <status>22</status>
          <trigger>paid</trigger>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items>
    </status><status>
      <id>21</id>
      <name>manual_amount</name>
      <colour>000000</colour>
      <visibility>
        <role>_receiver</role>
        <role>_debug</role>
      </visibility><items>
        <item id="1" type="jumponsubmit">
          <status>20</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item><item id="2" type="form">
          <by>
            <item role_id="_debug">_debug</item>
          </by><varname>manual</varname>
          <formdef>
            <name>-</name>
            <fields>
              <field>
                <label>Montant &#224; payer</label>
                <type>string</type>
                <required>True</required>
                <varname>amount</varname>
                <prefill>
                  <type>none</type>
                </prefill><anonymise>False</anonymise>
                <id>1</id>
              </field>
            </fields>
          </formdef>
        </item>
      </items>
    </status><status>
      <id>22</id>
      <name>_Cl&#244;tur&#233; et pay&#233;</name>
      <colour>00FF00</colour>
      <visibility />
      <items />
    </status>
  </possible_status><global_actions>
    <action>
      <id>1</id>
      <name>TEST CLOTURE</name>
      <items />
      <triggers />
    </action><action>
      <id>2</id>
      <name>REMOVE [!! NO ROLLBACK !!]</name>
      <items>
        <item id="1" type="remove" />
      </items><triggers>
        <trigger id="e255a45b-e38f-40dc-8762-e2e42bdaf0da" type="manual">
          <roles>
            <item role_id="_debug">_debug</item>
          </roles>
        </trigger>
      </triggers>
    </action><action>
      <id>3</id>
      <name>edit</name>
      <items />
      <triggers>
        <trigger id="846b154b-47ee-4570-a1c6-121af8823242" type="manual">
          <roles>
            <item role_id="_debug">_debug</item>
          </roles>
        </trigger>
      </triggers>
    </action><action>
      <id>4</id>
      <name>Remplir le panier manuellement</name>
      <items>
        <item id="1" type="jump">
          <status>21</status>
          <set_marker_on_status>False</set_marker_on_status>
        </item>
      </items><triggers>
        <trigger id="9a50acd1-f8e4-4887-8dc2-0efe1e85666c" type="manual">
          <roles>
            <item role_id="_debug">_debug</item>
          </roles>
        </trigger>
      </triggers>
    </action>
  </global_actions><variables>
    <formdef>
      <name>-</name>
      <fields>
        <field>
          <label>Commentaire personnalis&#233; en d&#233;but de formulaire</label>
          <type>text</type>
          <required>False</required>
          <hint>Ce message s'affichera au tout d&#233;but de ce formulaire.</hint>
          <varname>commentaire</varname>
          <prefill>
            <type>none</type>
          </prefill><pre>False</pre>
          <id>7</id>
        </field><field>
          <label>Date d'ouverture des plaines. (pour la p&#233;riode vis&#233;e)</label>
          <type>string</type>
          <required>True</required>
          <hint>Le premier jour de la premi&#232;re plaine de la p&#233;riode vis&#233;e.
Au format jj/mm/aaaa

(p&#233;riodes : Carnaval, plaines d'&#233;t&#233;, Toussaint,...)
exemple : Si les plaines d'&#233;t&#233; vont du 01/07/XXXX au 31/08/XXXX alors cette date sera 01/07/XXXX</hint>
          <varname>first_date_plain</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><prefill>
            <type>none</type>
          </prefill><anonymise>False</anonymise>
          <id>4</id>
        </field><field>
          <label>Date de fin des plaines.  (pour la p&#233;riode vis&#233;e)</label>
          <type>string</type>
          <required>True</required>
          <hint>Le dernier jour de la derni&#232;re plaine de la p&#233;riode vis&#233;e.
Au format jj/mm/aaaa

(p&#233;riodes : Carnaval, plaines d'&#233;t&#233;, Toussaint,...)
exemple : Si les plaines d'&#233;t&#233; vont du 01/07/XXXX au 31/08/XXXX alors cette date sera 31/08/XXXX</hint>
          <varname>last_date_plain</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><prefill>
            <type>none</type>
          </prefill><anonymise>True</anonymise>
          <id>5</id>
        </field><field>
          <label>Nombre de jour dans le panier avant lib&#233;ration des places</label>
          <type>string</type>
          <required>True</required>
          <varname>nb_days_before_free_places</varname>
          <prefill>
            <type>string</type>
            <value>3</value>
          </prefill><validation>
            <type>digits</type>
          </validation><anonymise>False</anonymise>
          <id>6</id>
        </field><field>
          <label>Cat&#233;gorie d'activit&#233;</label>
          <type>string</type>
          <required>True</required>
          <varname>categorie_d_activite</varname>
          <display_locations>
            <display_location>validation</display_location>
            <display_location>summary</display_location>
          </display_locations><anonymise>True</anonymise>
          <id>8</id>
        </field>
      </fields>
    </formdef>
  </variables><backoffice-fields>
    <formdef>
      <name>-</name>
      <fields>
        <field>
          <label>Adresse e-mail</label>
          <type>string</type>
          <required>True</required>
          <varname>email</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><anonymise>True</anonymise>
          <id>bo12327eb7-292e-4599-8770-f59b17b60c69</id>
        </field><field>
          <label>Tous les jours de plaine s&#233;lectionn&#233;s par le parent</label>
          <type>string</type>
          <required>False</required>
          <varname>jours_de_plaine</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><anonymise>False</anonymise>
          <id>boe38e8ffb-9eea-4ca5-8433-562d88c254bf</id>
        </field><field>
          <label>Semaines (calendrier) de plaine s&#233;lectionn&#233;es par le parent</label>
          <type>string</type>
          <required>False</required>
          <hint>Semaines "calendrier".</hint>
          <varname>semaines_de_plaine</varname>
          <display_locations>
            <display_location>summary</display_location>
            <display_location>listings</display_location>
          </display_locations><anonymise>False</anonymise>
          <id>bo0f67dbe9-82df-467a-adec-eb6e944f97af</id>
        </field><field>
          <label>aes : parent id</label>
          <type>string</type>
          <required>False</required>
          <varname>aes_parent_id</varname>
          <anonymise>False</anonymise>
          <id>boecf95bcc-b6f3-4c69-97a8-eb17e5d4ca76</id>
        </field><field>
          <label>(utils) compteur de r&#233;ponses aes</label>
          <type>string</type>
          <required>False</required>
          <varname>cpt_aes_response</varname>
          <anonymise>False</anonymise>
          <id>bob9991026-8b9a-4aa8-8161-bd6d26ac0b42</id>
        </field><field>
          <label>(utils) compteur "plus de place"</label>
          <type>string</type>
          <required>False</required>
          <varname>cpt_no_more_place</varname>
          <anonymise>False</anonymise>
          <id>bo9a83f6a7-2b4e-4c01-8950-193376e2c412</id>
        </field><field>
          <label>(utils) Nombre de semaines s&#233;lectionn&#233;es par le parent</label>
          <type>string</type>
          <required>True</required>
          <varname>nb_weeks</varname>
          <anonymise>False</anonymise>
          <id>bo536eed66-8e9a-4c58-b4d5-c54c84f0ccc8</id>
        </field><field>
          <label>(utils) Jours de plaine &#224; filtrer (refuse / validate)</label>
          <type>table</type>
          <required>False</required>
          <varname>days_will_be_filtering</varname>
          <rows>
            <row>day</row>
          </rows><columns>
            <column>days</column>
          </columns><id>bo17043065-244b-43fb-9911-148cfd2e2a96</id>
        </field><field>
          <label>(utils) Refus ou acceptation dans l'historique (message spontan&#233;)</label>
          <type>string</type>
          <required>False</required>
          <varname>msg_status_histo</varname>
          <anonymise>False</anonymise>
          <id>bo489d9a74-3e88-46f2-b98f-c815b2033927</id>
        </field><field>
          <label>(utils) Date de cl&#244;ture et de mise dans le panier</label>
          <type>date</type>
          <required>False</required>
          <varname>in_basket_date</varname>
          <minimum_is_future>False</minimum_is_future>
          <date_in_the_past>False</date_in_the_past>
          <date_can_be_today>False</date_can_be_today>
          <id>bo43d4f153-0ad6-4d0b-a31f-b24d11709299</id>
        </field><field>
          <label>(utils) Semaine en cours de validation</label>
          <type>string</type>
          <required>False</required>
          <varname>current_validating_week</varname>
          <anonymise>False</anonymise>
          <id>bof0e2cd2d-c92a-460a-99c6-8abdcbedd541</id>
        </field><field>
          <label>(utils) Cette demande est cl&#244;tur&#233;e</label>
          <type>bool</type>
          <required>False</required>
          <hint>Dans le script de cl&#244;ture, on va r&#233;cup&#233;rer les diff&#233;rentes demandes (d&#233;marches) r&#233;alis&#233;es par le parent dans une p&#233;riode donn&#233;e. Ces demandes vont &#234;tre envoy&#233;es &#224; AES pour calculer un montant. Il ne faut &#233;videmment pas r&#233;envoyer les demandes qui ont d&#233;j&#224; &#233;t&#233; cl&#244;tur&#233;es dans cette p&#233;riode et qui ont d&#233;j&#224; fait l'objet d'un paiement. Ce flag permet de certifier qu'on est d&#233;j&#224; pass&#233; par le status "cl&#244;tur&#233;".</hint>
          <varname>is_close</varname>
          <id>bo3b7197e9-7b19-4e8e-9fb4-f9b3b9a7c89c</id>
        </field><field>
          <label>(utils) Cette demande est d&#233;j&#224; pass&#233;e par le panier</label>
          <type>bool</type>
          <required>False</required>
          <varname>was_in_basket</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><id>bo7614c7ef-0731-4205-9cd1-9bdfa9e26544</id>
        </field><field>
          <label>(utils) Libell&#233; article panier</label>
          <type>string</type>
          <required>False</required>
          <hint>Texte du libell&#233; de l'article qui appaitra dans le panier mais aussi dans l'historique de la demande qui a cl&#244;tur&#233; les autres demandes. </hint>
          <varname>label_basket_item</varname>
          <anonymise>False</anonymise>
          <id>bo9620a85b-a884-4b8f-84ff-024dc4f516af</id>
        </field><field>
          <label>Refus et acceptations pour mail final (messages concat&#233;n&#233;s)</label>
          <type>string</type>
          <required>False</required>
          <varname>finalmail</varname>
          <anonymise>False</anonymise>
          <id>bo87ac6923-e30f-4862-9d91-d6a3f06f96bb</id>
        </field><field>
          <label>register_first_date_plaine</label>
          <type>string</type>
          <required>False</required>
          <varname>reg_first_date_plaine</varname>
          <anonymise>False</anonymise>
          <id>bo5756c702-afb1-486a-8300-c45736a4148a</id>
        </field><field>
          <label>register_last_date_plaine</label>
          <type>string</type>
          <required>False</required>
          <varname>reg_last_date_plaine</varname>
          <anonymise>False</anonymise>
          <id>boccf860cf-383c-4cf6-9137-c7db1283e229</id>
        </field><field>
          <label>D&#233;marches cl&#244;tur&#233;es</label>
          <type>string</type>
          <required>True</required>
          <hint>Dans cette variable, on enregistre les num&#233;ros de demandes "filles" que la d&#233;marche "m&#232;re" (is_closing_request = True) a effectivement cl&#244;tur&#233;. la variable form_var_closed_plaines est enregistr&#233;e = "" dans les "demandes filles"</hint>
          <varname>closed_plaines</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><anonymise>True</anonymise>
          <id>bo3d9cb807-a5af-44db-b4f8-abc5bb9c0adf</id>
        </field><field>
          <label>D&#233;marches cl&#244;tur&#233;es et pay&#233;es</label>
          <type>string</type>
          <required>False</required>
          <varname>closed_and_paid_plaines</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><anonymise>False</anonymise>
          <id>bo96d77efd-9a54-492d-940b-9c11e1282761</id>
        </field><field>
          <label>C'est LA demande de cl&#244;ture</label>
          <type>bool</type>
          <required>False</required>
          <varname>is_closing_request</varname>
          <display_locations>
            <display_location>summary</display_location>
          </display_locations><id>bo5f6a808e-3e82-47bc-8f93-fdd8887c5309</id>
        </field>
      </fields>
    </formdef>
  </backoffice-fields>
</workflow>